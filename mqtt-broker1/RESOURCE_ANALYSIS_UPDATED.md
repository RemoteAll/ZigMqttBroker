# 资源消耗分析（更新版）

## 🔑 核心发现

**预热 1024 个连接对象仅占用 ~3 MB！**

这与之前的 ~11 MB 估算有很大出入。原因是 `MemoryPoolExtra.preheat()` 的工作机制：

- ✅ 只分配对象结构体本身的内存
- ❌ 不分配对象内部指向的数据（Arena、缓冲区等）

## 1. 实际内存占用

### 1.1 启动时内存占用

```
启动 Broker（配置 INITIAL_POOL_SIZE=1024）

固定开销
├─ 程序代码和静态数据：~5-10 MB
├─ 运行时堆栈：~1 MB
└─ 其他系统开销：~2 MB
   小计：~8-13 MB

连接池预热
├─ 1024 个 ClientConnection 结构体：~3 MB
│  （每个结构体约 3 KB）
└─ 元数据和管理信息：~0.5 MB
   小计：~3.5 MB

订阅树和持久化
├─ 订阅树初始化：~1 MB
├─ 持久化管理器：~0.5 MB
└─ 已加载的订阅数据（if any）：变量
   小计：~1.5 MB + 订阅数据

─────────────────────────────
总计：~12-18 MB（完全不需要 Arena、缓冲区等）
```

### 1.2 关键洞察

| 阶段 | 内存来源 | 占用 |
|------|---------|------|
| **启动完成** | 固定开销 + 池结构体 | ~3-5 MB |
| **首个连接建立** | + Arena (per conn) | +100-500 KB |
| **10K 连接** | + 10K × 缓冲区 | +40-100 MB |
| **100K 连接** | + 100K × 缓冲区 | +400-1000 MB |
| **1M 连接** | + 1M × 缓冲区 | +4-10 GB |

## 2. 单连接内存成本

当一个连接实际建立时：

```
ClientConnection 结构体本身：~3 KB（已在池中预分配）

+

Arena 分配器（per connection）：
├─ 初始化代码：~1 KB
├─ 用于连接内的各种分配：变量
│  ├─ Client 对象：~2-3 KB
│  ├─ 订阅列表：~100-500 B
│  └─ 消息队列初始化：~100 B
└─ 小计：~5-10 KB per connection

+

I/O 缓冲区：
├─ 读缓冲区（READ_BUFFER_SIZE）：4 KB
├─ 写缓冲区（WRITE_BUFFER_SIZE）：4 KB
└─ 小计：8 KB per connection

─────────────────────────────────
单连接总成本：~15-20 KB（包括预分配池中的部分）
```

## 3. 内存占用的实际数据

### 3.1 小型部署（测试 10K 连接）

**配置**：
```zig
pub const INITIAL_POOL_SIZE = 1024;
pub const MAX_POOL_SIZE = 100_000;
pub const MAX_CONNECTIONS = 1_000_000;
```

**内存占用**：

| 状态 | 内存 |
|------|------|
| 启动后 | ~3-5 MB |
| 10 个连接 | ~5-8 MB |
| 100 个连接 | ~10-15 MB |
| 1K 个连接 | ~30-50 MB |
| 10K 个连接 | **~160-250 MB** |

### 3.2 中型部署（100K 连接）

**配置**：
```zig
pub const INITIAL_POOL_SIZE = 5_000;
pub const MAX_POOL_SIZE = 100_000;
pub const MAX_CONNECTIONS = 100_000;
```

**内存占用**：

| 状态 | 内存 |
|------|------|
| 启动后 | ~15 MB |
| 达到预热上限 (5K) | ~100-150 MB |
| 自动扩展到 7.5K | ~150-225 MB |
| 自动扩展到 11.2K | ~225-336 MB |
| ... 逐步扩展 ... | ... |
| 达到 100K | **~1.5-2 GB** |

### 3.3 大型部署（1M 连接）

**配置**：
```zig
pub const INITIAL_POOL_SIZE = 10_000;
pub const MAX_POOL_SIZE = 100_000;
pub const MAX_CONNECTIONS = 1_000_000;
```

**内存占用曲线**：

```
启动：~50 MB
↓
自动扩展至 100K：~1.5-2 GB
↓
100K - 1M：需要动态分配 Arena 和缓冲区
↓
最终 1M 连接：~15-20 GB
```

## 4. 与预期的差异

### 之前的估算

```
预热 1024 连接：~11 MB（错误！）
原因：假设每个预热的对象都包含完整的 Arena 和缓冲区

实际：~3 MB（正确）
原因：只有对象结构体，Arena 和缓冲区按需分配
```

### 修正后的理解

```
┌─────────────────────────────────────────────────┐
│ 连接池预热的真正含义                           │
├─────────────────────────────────────────────────┤
│                                                 │
│ preheat(N) 的作用：                            │
│ ✓ 预分配 N 个 ClientConnection 对象结构       │
│ ✓ 这样新连接到达时无需分配对象本身            │
│ ✗ 不预分配 Arena 或缓冲区                      │
│                                                 │
│ 优势：                                          │
│ • 启动内存极少（~ 3-5 MB）                     │
│ • 新连接建立时只需分配 Arena 和缓冲区         │
│ • 避免浪费预分配的未使用 Arena                 │
│                                                 │
└─────────────────────────────────────────────────┘
```

## 5. 内存使用的实际特性

### 5.1 启动时内存

- 非常小：**3-5 MB**
- 主要是池的结构体和元数据
- 完全可以接受

### 5.2 连接建立时的内存

- 首次建立连接时创建 Arena
- Arena 按需增长（不是预分配的固定大小）
- 读写缓冲区各 4 KB 固定
- 总计：**~10-20 KB per connection**

### 5.3 内存按需增长

```
时间 ──────────────────────────────→

内存
  ↑
  │  ╱╱╱╱╱╱╱╱╱╱ 按需增长（每个连接 10-20 KB）
  │ ╱
  │╱ 快速启动阶段（3 MB）
  └────────────────────────────────→

优点：
✓ 启动快（无大量预分配）
✓ 内存按需（无浪费）
✓ 可扩展（支持百万连接）
```

## 6. 推荐配置（基于真实数据）

### 小型（< 10K）

```zig
pub const INITIAL_POOL_SIZE = 1024;      // 启动 ~3 MB
pub const MAX_POOL_SIZE = 10_000;        // 最多预热 30 MB
pub const MAX_CONNECTIONS = 10_000;
```

**预期内存**：启动 3 MB → 10K 连接时 150-250 MB

### 中型（10K - 100K）

```zig
pub const INITIAL_POOL_SIZE = 5_000;     // 启动 ~15 MB
pub const MAX_POOL_SIZE = 100_000;       // 最多预热 300 MB
pub const MAX_CONNECTIONS = 100_000;
```

**预期内存**：启动 15 MB → 100K 连接时 1.5-2 GB

### 大型（100K - 1M）

```zig
pub const INITIAL_POOL_SIZE = 10_000;    // 启动 ~30 MB
pub const MAX_POOL_SIZE = 100_000;       // 最多预热 300 MB
pub const MAX_CONNECTIONS = 1_000_000;
```

**预期内存**：启动 30 MB → 1M 连接时 15-20 GB

## 7. 与硬件的匹配

### 基于可用内存的推荐

| 内存 | 推荐配置 | 支持连接数 |
|------|---------|----------|
| 512 MB | INITIAL_POOL_SIZE=256 | ~30K |
| 1 GB | INITIAL_POOL_SIZE=512 | ~50K |
| 2 GB | INITIAL_POOL_SIZE=1024 | ~100K |
| 4 GB | INITIAL_POOL_SIZE=2048 | ~200K |
| 8 GB | INITIAL_POOL_SIZE=5000 | ~500K |
| 16+ GB | INITIAL_POOL_SIZE=10000 | ~1M |

## 8. 动态扩展的成本

每次 auto-expand 时的额外分配：

```
原预热：1024 → 扩展到 1536（+512 个对象）
成本：+512 × 3 KB ≈ 1.5 MB

原预热：1536 → 扩展到 2304（+768 个对象）
成本：+768 × 3 KB ≈ 2.3 MB
```

扩展成本很小，不会造成明显的内存毛刺。

## 9. 完整的内存分配时间线

```
T0: 启动 Broker
    内存：3-5 MB
    └─ 池结构体和固定开销

T1: 接收第一个连接
    内存：+10-20 KB
    └─ 创建 Arena 和缓冲区

T2: 接收更多连接（直到 1024 个）
    内存：线性增长
    └─ 每个连接 10-20 KB

T3: 接收第 1025 个连接（触发扩展阈值）
    事件：自动扩展至 1536
    成本：+1.5 MB（对象结构体）
    内存：从 3 MB 扩展到 4.5 MB

T4: 继续接收连接...
    内存：继续线性增长
```

## 10. 总结表格

| 指标 | 新认识 | 备注 |
|------|--------|------|
| 预热 1K 对象 | ~3 MB | 仅结构体，无 Arena/缓冲区 |
| 单连接额外 | ~15 KB | 包括 Arena 和缓冲区 |
| 启动时间 | < 1 秒 | 非常快 |
| 扩展成本 | ~1-2 MB | 每次扩展时的额外预热 |
| 最终内存 | 按连接数 | ~15-20 KB × 连接数 |

---

**更新日期**：2025-10-24  
**版本**：2.0（修正了预热内存计算）  
**实测基础**：运行时实际 3 MB 内存占用
